<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kurye Takip</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{
  background:#111;
  color:#eee;
  font-family:Arial;
  margin:0;
  padding:12px
}
.container{max-width:900px;margin:auto}
h2{margin-top:25px;border-bottom:1px solid #333;padding-bottom:5px}
input,select,button{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:6px;
  border:none;
  font-size:15px
}
input,select{background:#222;color:#fff}
button{background:#1e88e5;color:#fff}
button.danger{background:#c62828}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:14px
}
th,td{
  border-bottom:1px solid #333;
  padding:6px;
  text-align:center
}
th{background:#1a1a1a}
.status{
  display:inline-block;
  width:8px;height:8px;
  border-radius:50%;
}
.red{background:#e53935}
.green{background:#43a047}
</style>
</head>

<body onload="yenile()">
<div class="container">

<h2>ğŸ“¦ GÃ¼nlÃ¼k Ä°ÅŸlem</h2>

<input id="isletme" placeholder="Ä°ÅŸletme adÄ±">
<input id="paket" type="number" placeholder="Paket sayÄ±sÄ±">
<input id="ucret" type="number" placeholder="Paket Ã¼creti">
<input id="tahsilat" type="number" placeholder="Tahsil edilen">

<button onclick="ekle()">â• Kaydet</button>

<h2>ğŸ“‹ GÃ¼nlÃ¼k KayÄ±tlar</h2>

<select id="silGunluk"></select>
<button class="danger" onclick="gunlukSil()">SeÃ§ili Ä°ÅŸletmenin GÃ¼nlÃ¼k KayÄ±tlarÄ±nÄ± Sil</button>

<table>
<thead>
<tr>
<th>Tarih</th>
<th>Ä°ÅŸletme</th>
<th>Ä°ÅŸlem</th>
<th>Tutar</th>
<th>Tahsilat</th>
<th>Bakiye</th>
</tr>
</thead>
<tbody id="liste"></tbody>
</table>

<h2>ğŸ” GÃ¼ncel Devir Durumu</h2>

<select id="silDevir"></select>
<button class="danger" onclick="devirSil()">SeÃ§ili Deviri Sil</button>

<table>
<thead>
<tr>
<th>Ä°ÅŸletme</th>
<th>Bakiye</th>
<th></th>
</tr>
</thead>
<tbody id="devirListe"></tbody>
</table>

<button onclick="excel()">ğŸ“¥ Excel Ä°ndir</button>

</div>

<script>
let kayitlar = JSON.parse(localStorage.getItem("gunlukKayitlar")) || [];
let devirler = JSON.parse(localStorage.getItem("devirler")) || {};

const bugun = ()=>new Date().toISOString().slice(0,10);
const N = x=>x.trim().toUpperCase();

function ekle(){
  const i=N(isletme.value);
  const p=+paket.value||0;
  const u=+ucret.value||0;
  const t=+tahsilat.value||0;
  if(!i) return alert("Ä°ÅŸletme gir");

  if(!devirler[i]) devirler[i]=0;

  const tarih=bugun();

  let satir = kayitlar.find(k =>
    k.Tarih===tarih &&
    k.Isletme===i &&
    k.Islem==="Teslimat"
  );

  if(p>0 && u>0){
    const tutar=p*u;
    const tah=t||0;
    const etki=tutar-tah;

    kayitlar.push({
      Tarih:tarih,
      Isletme:i,
      Islem:"Teslimat",
      Paket:p,
      Tutar:tutar,
      Tahsilat:tah,
      Etki:etki
    });
    devirler[i]+=etki;

  } else if(t>0){
    if(satir){
      satir.Tahsilat+=t;
      satir.Etki-=t;
    }
    devirler[i]-=t;
  } else {
    return alert("Bilgi eksik");
  }

  kaydet();
}

function kaydet(){
  localStorage.setItem("gunlukKayitlar",JSON.stringify(kayitlar));
  localStorage.setItem("devirler",JSON.stringify(devirler));
  paket.value=ucret.value=tahsilat.value="";
  yenile();
}

function yenile(){
  liste.innerHTML="";
  let bakiye={};

  kayitlar.forEach(k=>{
    if(!bakiye[k.Isletme]) bakiye[k.Isletme]=0;
    bakiye[k.Isletme]+=k.Etki;

    liste.innerHTML+=`
    <tr>
      <td>${k.Tarih}</td>
      <td>${k.Isletme}</td>
      <td>${k.Islem}</td>
      <td>${k.Tutar||"-"}</td>
      <td>${k.Tahsilat||"-"}</td>
      <td>${bakiye[k.Isletme]} TL</td>
    </tr>`;
  });

  devirListe.innerHTML="";
  Object.keys(devirler).forEach(i=>{
    const d=devirler[i];
    const renk=d>0?"red":"green";
    devirListe.innerHTML+=`
    <tr>
      <td>${i}</td>
      <td>${d} TL</td>
      <td><span class="status ${renk}"></span></td>
    </tr>`;
  });

  doldur();
}

function doldur(){
  silGunluk.innerHTML="<option>GÃ¼nlÃ¼k iÅŸletme seÃ§</option>";
  [...new Set(kayitlar.map(k=>k.Isletme))].forEach(i=>{
    silGunluk.innerHTML+=`<option>${i}</option>`;
  });

  silDevir.innerHTML="<option>Devir seÃ§</option>";
  Object.keys(devirler).forEach(i=>{
    silDevir.innerHTML+=`<option>${i}</option>`;
  });
}

function gunlukSil(){
  const i=silGunluk.value;
  if(!i) return;
  if(!confirm(i+" gÃ¼nlÃ¼k kayÄ±tlarÄ± silinsin mi?")) return;
  kayitlar=kayitlar.filter(k=>k.Isletme!==i);
  kaydet();
}

function devirSil(){
  const i=silDevir.value;
  if(!i) return;
  if(!confirm(i+" devri silinsin mi?")) return;
  delete devirler[i];
  kaydet();
}

function excel(){
  const wb=XLSX.utils.book_new();
  let bakiye={};

  const gunluk=kayitlar.map(k=>{
    if(!bakiye[k.Isletme]) bakiye[k.Isletme]=0;
    bakiye[k.Isletme]+=k.Etki;
    return{
      Tarih:k.Tarih,
      Isletme:k.Isletme,
      Islem:k.Islem,
      Paket:k.Paket||"",
      Tutar:k.Tutar||"",
      Tahsilat:k.Tahsilat||"",
      Etki:k.Etki,
      "Kalan Bakiye":bakiye[k.Isletme]
    }
  });

  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(gunluk),"Gunluk");

  const durum=Object.keys(devirler).map(i=>({
    Isletme:i,
    "Kalan Bakiye":devirler[i]
  }));

  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(durum),"GÃ¼ncel Durum");

  XLSX.writeFile(wb,"Kurye_Takip.xlsx");
}
</script>
</body>
</html>
